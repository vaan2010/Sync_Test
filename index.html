<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase æ»¾å‹•å‚™ä»½è¨˜å¸³ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .container { max-width: 900px; }
        .hidden { display: none; }
        .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .backup-item { cursor: pointer; transition: background 0.2s; }
        .backup-item:hover { background-color: #e9ecef; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center mb-4">ğŸ”„ æ»¾å‹•å‚™ä»½è¨˜å¸³ç³»çµ±</h2>

    <div id="login-section" class="text-center">
        <div class="card p-5">
            <h4>è«‹å…ˆç™»å…¥</h4>
            <button id="btn-login" class="btn btn-primary btn-lg">Google ç™»å…¥</button>
        </div>
    </div>

    <div id="app-section" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 id="user-display-name">ä½¿ç”¨è€…ï¼š...</h5>
            <button id="btn-logout" class="btn btn-outline-danger btn-sm">ç™»å‡º</button>
        </div>

        <div class="row">
            <div class="col-md-7">
                <div class="card">
                    <div class="card-header bg-primary text-white">ğŸ“ å³æ™‚è¨˜å¸³æœ¬</div>
                    <div class="card-body">
                        <form id="form-add" class="mb-3">
                            <div class="input-group">
                                <input type="text" id="input-item" class="form-control" placeholder="é …ç›®" required>
                                <input type="number" id="input-amount" class="form-control" placeholder="é‡‘é¡" required>
                                <button type="submit" class="btn btn-success">æ–°å¢</button>
                            </div>
                        </form>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm">
                                <thead><tr><th>é …ç›®</th><th>é‡‘é¡</th><th>æ“ä½œ</th></tr></thead>
                                <tbody id="list-container"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-5">
                <div class="card">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <span>â˜ï¸ é›²ç«¯å‚™ä»½ (æœ€æ–° 10 ç­†)</span>
                        <button id="btn-force-backup" class="btn btn-sm btn-light">æ‰‹å‹•å‚™ä»½</button>
                    </div>
                    <div class="card-body">
                        <small class="text-muted d-block mb-2">
                            ç³»çµ±æ¯å°æ™‚æª¢æŸ¥ä¸€æ¬¡ï¼Œè¶…é 10 ç­†è‡ªå‹•åˆªé™¤æœ€èˆŠçš„ã€‚
                            <br>é»æ“Šä¸‹æ–¹åˆ—è¡¨å³å¯ã€Œé‚„åŸã€è‡³è©²æ™‚é–“é»ã€‚
                        </small>
                        <div class="list-group" id="backup-list-container">
                            <div class="text-center py-3 text-muted">è®€å–ä¸­...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, deleteDoc, getDocs, writeBatch, Timestamp, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // !!! è«‹å¡«å…¥æ‚¨çš„ Firebase Config !!!
    const firebaseConfig = {
        apiKey: "AIzaSyDxxxx...",
        authDomain: "your-project.firebaseapp.com",
        projectId: "your-project-id",
        storageBucket: "your-project.appspot.com",
        messagingSenderId: "123",
        appId: "1:123:web:abc"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;

    // DOM å…ƒç´ 
    const listContainer = document.getElementById('list-container');
    const backupListContainer = document.getElementById('backup-list-container');

    // 1. ç™»å…¥/ç™»å‡º
    document.getElementById('btn-login').addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()));
    document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
            document.getElementById('user-display-name').textContent = `ä½¿ç”¨è€…ï¼š${user.displayName}`;
            
            // å•Ÿå‹•åŠŸèƒ½
            listenToRecords();
            listenToBackups(); // ç›£è½å‚™ä»½åˆ—è¡¨
            checkAndAutoBackup(); // æª¢æŸ¥æ˜¯å¦éœ€è¦è‡ªå‹•å‚™ä»½
        } else {
            currentUser = null;
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('app-section').classList.add('hidden');
        }
    });

    // 2. å³æ™‚è¨˜å¸³åŠŸèƒ½ (Live Data)
    function listenToRecords() {
        const q = query(collection(db, "users", currentUser.uid, "records"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            listContainer.innerHTML = '';
            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                listContainer.innerHTML += `
                    <tr>
                        <td>${data.item}</td>
                        <td>$${data.amount}</td>
                        <td><button onclick="window.deleteRecord('${docSnap.id}')" class="btn btn-danger btn-sm">X</button></td>
                    </tr>`;
            });
        });
    }

    // åˆªé™¤å–®ç­† (æ›è¼‰åˆ° window ä»¥ä¾¿ onclick å‘¼å«)
    window.deleteRecord = async (id) => {
        if(confirm('åˆªé™¤æ­¤ç­†?')) await deleteDoc(doc(db, "users", currentUser.uid, "records", id));
    };

    // æ–°å¢
    document.getElementById('form-add').addEventListener('submit', async (e) => {
        e.preventDefault();
        const item = document.getElementById('input-item').value;
        const amount = Number(document.getElementById('input-amount').value);
        await addDoc(collection(db, "users", currentUser.uid, "records"), {
            item, amount, createdAt: Timestamp.now()
        });
        e.target.reset();
    });

    // =========================================================
    // 3. æ ¸å¿ƒé‚è¼¯ï¼šæ»¾å‹•å‚™ä»½ç³»çµ±
    // =========================================================

    // ç›£è½å‚™ä»½åˆ—è¡¨ (å³å´ UI)
    function listenToBackups() {
        const q = query(collection(db, "users", currentUser.uid, "backups"), orderBy("backupTime", "desc"));
        onSnapshot(q, (snapshot) => {
            backupListContainer.innerHTML = '';
            let count = 0;
            if (snapshot.empty) {
                backupListContainer.innerHTML = '<div class="text-center p-3 text-muted">å°šç„¡å‚™ä»½</div>';
                return;
            }

            snapshot.forEach((docSnap) => {
                count++;
                const data = docSnap.data();
                const time = data.backupTime.toDate().toLocaleString();
                const recordCount = JSON.parse(data.jsonData).length;
                
                // å»ºç«‹åˆ—è¡¨é …ç›® (é»æ“Šå¾©åŸ)
                const div = document.createElement('div');
                div.className = 'list-group-item list-group-item-action backup-item';
                div.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">å‚™ä»½ #${count}</h6>
                        <small>${time}</small>
                    </div>
                    <small>åŒ…å« ${recordCount} ç­†è³‡æ–™</small>
                `;
                div.onclick = () => restoreFromBackup(docSnap.id, time);
                backupListContainer.appendChild(div);
            });
        });
    }

    // åŸ·è¡Œå‚™ä»½ (æ ¸å¿ƒæ¼”ç®—æ³•)
    async function performBackup(isAuto = false) {
        console.log("é–‹å§‹åŸ·è¡Œå‚™ä»½...");
        try {
            // A. æŠ“å–ç›®å‰æ‰€æœ‰ã€Œæ´»ã€çš„è³‡æ–™
            const recordsRef = collection(db, "users", currentUser.uid, "records");
            const snapshot = await getDocs(recordsRef);
            const recordsData = [];
            snapshot.forEach(doc => recordsData.push(doc.data()));

            // å¦‚æœæ²’è³‡æ–™ï¼Œé€šå¸¸ä¸å‚™ä»½ï¼Œä½†çœ‹éœ€æ±‚
            if (recordsData.length === 0 && isAuto) return;

            // B. æº–å‚™å¯«å…¥ backups é›†åˆ
            const backupsRef = collection(db, "users", currentUser.uid, "backups");
            const newBackupData = {
                backupTime: Timestamp.now(),
                jsonData: JSON.stringify(recordsData) // å°‡æ•´åŒ…è³‡æ–™è½‰æˆå­—ä¸²å­˜å…¥ä¸€å€‹æ¬„ä½
            };

            // C. æª¢æŸ¥æ•¸é‡é™åˆ¶ (Rolling Logic)
            // 1. å…ˆæŠ“å‡ºæ‰€æœ‰å‚™ä»½ï¼ŒæŒ‰æ™‚é–“æ’åº
            const q = query(backupsRef, orderBy("backupTime", "asc")); 
            const backupSnapshot = await getDocs(q);
            
            // 2. å¦‚æœæ•¸é‡ >= 10ï¼Œåˆªé™¤æœ€èˆŠçš„ (å¯èƒ½æœ‰å¤šç­†ï¼Œè¿´åœˆåˆªé™¤ç›´åˆ°å‰© 9 ç­†)
            const MAX_BACKUPS = 10;
            if (backupSnapshot.size >= MAX_BACKUPS) {
                const deleteCount = backupSnapshot.size - MAX_BACKUPS + 1; // +1 æ˜¯å› ç‚ºæˆ‘å€‘ç­‰ä¸‹è¦åŠ ä¸€ç­†æ–°çš„
                for (let i = 0; i < deleteCount; i++) {
                    const docToDelete = backupSnapshot.docs[i];
                    console.log(`åˆªé™¤èˆŠå‚™ä»½: ${docToDelete.id}`);
                    await deleteDoc(docToDelete.ref);
                }
            }

            // D. å¯«å…¥æ–°å‚™ä»½
            await addDoc(backupsRef, newBackupData);
            console.log("å‚™ä»½å®Œæˆ");
            if(!isAuto) alert("å‚™ä»½å·²å»ºç«‹ï¼");

        } catch (error) {
            console.error("å‚™ä»½å¤±æ•—", error);
            if(!isAuto) alert("å‚™ä»½å¤±æ•—: " + error.message);
        }
    }

    // è‡ªå‹•æª¢æŸ¥èˆ‡å‚™ä»½è§¸ç™¼
    async function checkAndAutoBackup() {
        const backupsRef = collection(db, "users", currentUser.uid, "backups");
        // æŠ“æœ€æ–°çš„é‚£ä¸€ç­†å‚™ä»½
        const q = query(backupsRef, orderBy("backupTime", "desc"), limit(1));
        const snapshot = await getDocs(q);

        let shouldBackup = false;
        if (snapshot.empty) {
            shouldBackup = true; // å¾ä¾†æ²’å‚™ä»½é
        } else {
            const lastTime = snapshot.docs[0].data().backupTime.toDate();
            const now = new Date();
            const diffHours = (now - lastTime) / (1000 * 60 * 60);
            
            if (diffHours >= 1) { // è¨­å®šï¼šè¶…é 1 å°æ™‚
                shouldBackup = true;
            }
        }

        if (shouldBackup) {
            await performBackup(true);
        }
    }

    // å¾©åŸè³‡æ–™ (Restore Logic)
    async function restoreFromBackup(backupId, backupTimeStr) {
        if (!confirm(`âš ï¸ è­¦å‘Šï¼šé€™å°‡æœƒã€Œæ¸…ç©ºã€ç›®å‰çš„è¨˜å¸³åˆ—è¡¨ï¼Œä¸¦å®Œå…¨æ›¿æ›æˆ [${backupTimeStr}] çš„ç‹€æ…‹ã€‚\n\nç¢ºå®šè¦å¾©åŸå—ï¼Ÿ`)) {
            return;
        }

        try {
            // 1. è®€å–è©²å‚™ä»½æª”æ¡ˆ
            const backupDoc = await getDocs(query(collection(db, "users", currentUser.uid, "backups")));
            // é€™è£¡ç›´æ¥ç”¨ ID æŠ“æœƒæ›´å¿«ï¼Œä½†ç‚ºäº†é‚è¼¯ç°¡å–®æˆ‘ç›´æ¥ç”¨æ—¢æœ‰çš„ snapshot æ¦‚å¿µï¼Œ
            // ä¿®æ­£ï¼šç›´æ¥ç”¨ doc ref æŠ“å–®ç­†
            const targetBackupRef = doc(db, "users", currentUser.uid, "backups", backupId);
            const targetSnap = await getDocs(query(collection(db, "users", currentUser.uid, "backups"))); // é‡æ–°æŠ“å–ç¢ºä¿è³‡æ–™æ­£ç¢º
            // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘ç›´æ¥ç”¨ ID è®€å–
            // (å›  firebase æ¨¡çµ„åŒ–å¯«æ³•è¼ƒé•·ï¼Œé€™è£¡ç”¨ç°¡å–®é‚è¼¯)
        
            // ä¿®æ­£å¾©åŸé‚è¼¯ï¼š
            // A. å–å¾—å‚™ä»½å…§å®¹
            // æˆ‘å€‘éœ€è¦é‡æ–° `getDoc` ç¢ºä¿æ‹¿åˆ°è³‡æ–™ (å› ç‚º snapshot æœ‰æ™‚å€™åªå« metadata)
            // é€™è£¡é‡æ–°å¯¦ä½œ getDoc
            // å¯¦éš›ä¸Šï¼Œæˆ‘å€‘éœ€è¦å¼•å…¥ getDocã€‚åœ¨ import è™•éœ€è£œä¸Š getDoc (å·²æ–¼ä¸Šæ–¹è£œä¸Šä½†ç‚ºç¢ºä¿ï¼Œæ­¤è™•ç”¨ query æ¨¡æ“¬)
            // ç°¡å–®ä½œæ³•ï¼š
            let backupDataStr = "";
            backupListContainer.childNodes.forEach(node => {
               // å¯¦ä½œä¸Šç›´æ¥å¾è³‡æ–™åº«è®€å–å–®ç­†æœ€æº–
            });
            // è®“æˆ‘å€‘ç›´æ¥å¾è³‡æ–™åº«è®€è©²ç­† ID
            const snap = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js")
                .then(m => m.getDoc(targetBackupRef));
            
            if(!snap.exists()) { alert("å‚™ä»½æª”ä¸å­˜åœ¨"); return; }
            
            const recordsToRestore = JSON.parse(snap.data().jsonData);

            // B. æ¸…ç©ºç›®å‰çš„ records (å±éšªæ“ä½œï¼Œä½¿ç”¨ Batch)
            const currentRecordsSnap = await getDocs(collection(db, "users", currentUser.uid, "records"));
            const batch = writeBatch(db);

            // åˆªé™¤èˆŠçš„
            currentRecordsSnap.forEach((doc) => {
                batch.delete(doc.ref);
            });

            // å¯«å…¥å‚™ä»½çš„
            recordsToRestore.forEach((record) => {
                const newRef = doc(collection(db, "users", currentUser.uid, "records"));
                // ç¢ºä¿æŠŠ createdAt è½‰å› Timestamp ç‰©ä»¶ï¼Œä¸ç„¶å­˜é€²å»æœƒè®Šå­—ä¸²
                if (record.createdAt && record.createdAt.seconds) {
                    record.createdAt = new Timestamp(record.createdAt.seconds, record.createdAt.nanoseconds);
                } else {
                    record.createdAt = Timestamp.now();
                }
                batch.set(newRef, record);
            });

            await batch.commit();
            alert("å¾©åŸæˆåŠŸï¼");

        } catch (e) {
            console.error(e);
            alert("å¾©åŸå¤±æ•—ï¼š" + e.message);
        }
    }

    // ç¶å®šæ‰‹å‹•å‚™ä»½æŒ‰éˆ•
    document.getElementById('btn-force-backup').addEventListener('click', () => performBackup(false));
    
    // å®šæ™‚å™¨ï¼šç¶²é é–‹è‘—çš„æ™‚å€™ï¼Œæ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡æ˜¯å¦è©²å‚™ä»½äº†
    setInterval(checkAndAutoBackup, 60 * 1000); 

</script>
</body>
</html>
