<!DOCTYPE html> 
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase å€‹äººè¨˜å¸³èˆ‡å‚™ä»½ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .container { max-width: 800px; }
        .hidden { display: none; }
        .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center mb-4">â˜ï¸ Cloud Firestore è¨˜å¸³å‚™ä»½ç¯„ä¾‹</h2>

    <div id="login-section" class="text-center">
        <div class="card p-5">
            <h4>è«‹å…ˆç™»å…¥ä»¥å­˜å–æ‚¨çš„è¨˜å¸³æœ¬</h4>
            <p class="text-muted">ä¸åŒä½¿ç”¨è€…çš„è³‡æ–™å°‡å®Œå…¨åˆ†é–‹å„²å­˜</p>
            <button id="btn-login" class="btn btn-primary btn-lg">ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</button>
        </div>
    </div>

    <div id="app-section" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 id="user-display-name">ä½¿ç”¨è€…ï¼š...</h5>
            <button id="btn-logout" class="btn btn-outline-danger btn-sm">ç™»å‡º</button>
        </div>

        <div id="backup-alert" class="alert alert-warning hidden" role="alert">
            âš ï¸ æ‚¨å·²ç¶“å¾ˆä¹…æ²’æœ‰å‚™ä»½äº†ï¼å»ºè­°ç«‹å³ä¸‹è¼‰å‚™ä»½ã€‚
        </div>

        <div class="card">
            <div class="card-header bg-info text-white">ğŸ’¾ è³‡æ–™å‚™ä»½èˆ‡å¾©åŸç®¡ç†</div>
            <div class="card-body">
                <div class="row g-3 align-items-center">
                    <div class="col-auto">
                        <label class="col-form-label">æé†’é »ç‡ (å¤©)ï¼š</label>
                    </div>
                    <div class="col-auto">
                        <input type="number" id="backup-frequency" class="form-control" value="7" min="1" style="width: 80px;">
                    </div>
                    <div class="col-auto">
                        <button id="btn-save-settings" class="btn btn-secondary btn-sm">å„²å­˜è¨­å®š</button>
                    </div>
                    <div class="col-auto ms-auto">
                        <span id="last-backup-text" class="text-muted small me-2">ä¸Šæ¬¡å‚™ä»½ï¼šç„¡</span>
                    </div>
                </div>
                <hr>
                <div class="d-flex gap-2">
                    <button id="btn-backup" class="btn btn-success">â¬‡ï¸ ä¸‹è¼‰å‚™ä»½ (JSON)</button>
                    
                    <button class="btn btn-warning" onclick="document.getElementById('file-restore').click()">â¬†ï¸ å¾©åŸè³‡æ–™ (JSON)</button>
                    <input type="file" id="file-restore" accept=".json" style="display: none;">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">ğŸ“ æ–°å¢ä¸€ç­†æ¶ˆè²»</div>
            <div class="card-body">
                <form id="form-add">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <input type="date" id="input-date" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <input type="text" id="input-item" class="form-control" placeholder="é …ç›® (ä¾‹å¦‚: æ—©é¤)" required>
                        </div>
                        <div class="col-md-2">
                            <input type="number" id="input-amount" class="form-control" placeholder="é‡‘é¡" required>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">æ–°å¢</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header">ğŸ“‹ æ”¶æ”¯æ˜ç´°</div>
            <div class="card-body p-0">
                <table class="table table-striped mb-0">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>é …ç›®</th>
                            <th>é‡‘é¡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="list-container">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // ------------------------------------------------------------------
    // 1. Firebase è¨­å®š (è«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ Config)
    // ------------------------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, getDoc, getDocs, writeBatch, Timestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAyebCTYX0SdZbO_wTKVjMyQXmGsnmSkzs",
      authDomain: "travel-30c43.firebaseapp.com",
      databaseURL: "https://travel-30c43-default-rtdb.firebaseio.com",
      projectId: "travel-30c43",
      storageBucket: "travel-30c43.firebasestorage.app",
      messagingSenderId: "402035619902",
      appId: "1:402035619902:web:f492adf217821c093f396f",
      measurementId: "G-SPF452S4LR"
    };

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let unsubscribeList = null; // ç”¨æ–¼å–æ¶ˆå³æ™‚ç›£è½

    // ------------------------------------------------------------------
    // 2. DOM å…ƒç´ 
    // ------------------------------------------------------------------
    const loginSection = document.getElementById('login-section');
    const appSection = document.getElementById('app-section');
    const userDisplay = document.getElementById('user-display-name');
    const listContainer = document.getElementById('list-container');
    const backupAlert = document.getElementById('backup-alert');
    const lastBackupText = document.getElementById('last-backup-text');
    const freqInput = document.getElementById('backup-frequency');
    const todayStr = new Date().toISOString().split('T')[0];
    document.getElementById('input-date').value = todayStr;

    // ------------------------------------------------------------------
    // 3. èº«ä»½é©—è­‰é‚è¼¯
    // ------------------------------------------------------------------
    document.getElementById('btn-login').addEventListener('click', () => {
        signInWithPopup(auth, provider).catch(err => alert("ç™»å…¥å¤±æ•—: " + err.message));
    });

    document.getElementById('btn-logout').addEventListener('click', () => {
        signOut(auth);
    });

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            loginSection.classList.add('hidden');
            appSection.classList.remove('hidden');
            userDisplay.textContent = `å—¨ï¼Œ${user.displayName}ï¼`;
            
            // è¼‰å…¥è©²ä½¿ç”¨è€…çš„è³‡æ–™
            loadSettings();
            listenToRecords();
        } else {
            currentUser = null;
            loginSection.classList.remove('hidden');
            appSection.classList.add('hidden');
            listContainer.innerHTML = '';
            // å–æ¶ˆç›£è½ä»¥ç¯€çœè³‡æº
            if (unsubscribeList) unsubscribeList();
        }
    });

    // ------------------------------------------------------------------
    // 4. è³‡æ–™åº«é‚è¼¯ (è¨˜å¸³ CRUD)
    // ------------------------------------------------------------------
    
    // ç›£è½å³æ™‚è³‡æ–™
    function listenToRecords() {
        // è·¯å¾‘ï¼šusers/{uid}/records
        const q = query(
            collection(db, "users", currentUser.uid, "records"), 
            orderBy("date", "desc")
        );

        unsubscribeList = onSnapshot(q, (snapshot) => {
            listContainer.innerHTML = '';
            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.date}</td>
                    <td>${data.item}</td>
                    <td>$${data.amount}</td>
                    <td><button class="btn btn-sm btn-danger btn-delete" data-id="${docSnap.id}">åˆªé™¤</button></td>
                `;
                listContainer.appendChild(row);
            });

            // ç¶å®šåˆªé™¤æŒ‰éˆ•
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    if(confirm('ç¢ºå®šåˆªé™¤?')) {
                        const id = e.target.getAttribute('data-id');
                        await deleteDoc(doc(db, "users", currentUser.uid, "records", id));
                    }
                });
            });
        });
    }

    // æ–°å¢è³‡æ–™
    document.getElementById('form-add').addEventListener('submit', async (e) => {
        e.preventDefault();
        const date = document.getElementById('input-date').value;
        const item = document.getElementById('input-item').value;
        const amount = Number(document.getElementById('input-amount').value);

        try {
            await addDoc(collection(db, "users", currentUser.uid, "records"), {
                date, item, amount, createdAt: Timestamp.now()
            });
            e.target.reset();
            document.getElementById('input-date').value = todayStr; // é‡è¨­å›ä»Šå¤©
        } catch (error) {
            console.error("Error adding document: ", error);
            alert("æ–°å¢å¤±æ•—");
        }
    });

    // ------------------------------------------------------------------
    // 5. è¨­å®šèˆ‡å‚™ä»½æª¢æŸ¥é‚è¼¯
    // ------------------------------------------------------------------
    
    // è¼‰å…¥ä½¿ç”¨è€…è¨­å®š (å‚™ä»½é »ç‡ & ä¸Šæ¬¡å‚™ä»½æ™‚é–“)
    async function loadSettings() {
        const docRef = doc(db, "users", currentUser.uid, "settings", "config");
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            freqInput.value = data.backupFrequency || 7;
            
            if (data.lastBackupDate) {
                const lastDate = data.lastBackupDate.toDate(); // Firestore Timestamp è½‰ Date
                lastBackupText.textContent = `ä¸Šæ¬¡å‚™ä»½ï¼š${lastDate.toLocaleDateString()}`;
                checkBackupDue(lastDate, data.backupFrequency || 7);
            }
        } else {
            // é è¨­å€¼
            freqInput.value = 7;
        }
    }

    // æª¢æŸ¥æ˜¯å¦éœ€è¦æé†’å‚™ä»½
    function checkBackupDue(lastDate, frequencyDays) {
        const now = new Date();
        const diffTime = Math.abs(now - lastDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

        if (diffDays > frequencyDays) {
            backupAlert.classList.remove('hidden');
            backupAlert.textContent = `âš ï¸ æ³¨æ„ï¼šæ‚¨å·²ç¶“ ${diffDays} å¤©æ²’æœ‰å‚™ä»½è³‡æ–™äº†ï¼ˆè¨­å®šé »ç‡ï¼š${frequencyDays} å¤©ï¼‰ã€‚`;
        } else {
            backupAlert.classList.add('hidden');
        }
    }

    // å„²å­˜å‚™ä»½é »ç‡è¨­å®š
    document.getElementById('btn-save-settings').addEventListener('click', async () => {
        const freq = Number(freqInput.value);
        await setDoc(doc(db, "users", currentUser.uid, "settings", "config"), {
            backupFrequency: freq
        }, { merge: true });
        alert("è¨­å®šå·²å„²å­˜");
    });

    // ------------------------------------------------------------------
    // 6. å‚™ä»½ (Export) åŠŸèƒ½
    // ------------------------------------------------------------------
    document.getElementById('btn-backup').addEventListener('click', async () => {
        try {
            // 1. æŠ“å–æ‰€æœ‰è³‡æ–™
            const q = query(collection(db, "users", currentUser.uid, "records"));
            const querySnapshot = await getDocs(q);
            
            const records = [];
            querySnapshot.forEach((doc) => {
                // å°‡è³‡æ–™å–å‡ºï¼Œä¸åŒ…å« ID (å¾©åŸæ™‚æœƒç”Ÿæˆæ–° ID) æˆ–å¯é¸æ“‡åŒ…å«
                records.push(doc.data());
            });

            if (records.length === 0) {
                alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯å‚™ä»½");
                return;
            }

            // 2. è½‰æˆ JSON String
            const jsonString = JSON.stringify(records, null, 2);

            // 3. è§¸ç™¼ç€è¦½å™¨ä¸‹è¼‰
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_${currentUser.displayName}_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // 4. æ›´æ–°ã€Œä¸Šæ¬¡å‚™ä»½æ™‚é–“ã€
            await setDoc(doc(db, "users", currentUser.uid, "settings", "config"), {
                lastBackupDate: Timestamp.now()
            }, { merge: true });

            // æ›´æ–° UI
            lastBackupText.textContent = `ä¸Šæ¬¡å‚™ä»½ï¼šå‰›å‰›`;
            backupAlert.classList.add('hidden');
            alert(`å‚™ä»½æˆåŠŸï¼å…±ä¸‹è¼‰ ${records.length} ç­†è³‡æ–™ã€‚`);

        } catch (error) {
            console.error("å‚™ä»½å¤±æ•—:", error);
            alert("å‚™ä»½éç¨‹ç™¼ç”ŸéŒ¯èª¤");
        }
    });

    // ------------------------------------------------------------------
    // 7. å¾©åŸ (Restore/Import) åŠŸèƒ½
    // ------------------------------------------------------------------
    document.getElementById('file-restore').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (event) => {
            try {
                const records = JSON.parse(event.target.result);
                if (!Array.isArray(records)) {
                    throw new Error("æ ¼å¼éŒ¯èª¤ï¼šJSON å¿…é ˆæ˜¯é™£åˆ—æ ¼å¼");
                }

                if (!confirm(`ç¢ºå®šè¦åŒ¯å…¥ ${records.length} ç­†è³‡æ–™å—ï¼Ÿ\né€™å°‡æœƒæ–°å¢è³‡æ–™è‡³ç¾æœ‰åˆ—è¡¨ä¸­ (ä¸æœƒè¦†è“‹)ã€‚`)) {
                    e.target.value = ''; // æ¸…ç©ºé¸æ“‡
                    return;
                }

                // æ‰¹æ¬¡å¯«å…¥ (Firestore æ¯å€‹ batch ä¸Šé™ 500 ç­†)
                // é€™è£¡åšå€‹ç°¡å–®çš„è¿´åœˆè™•ç† (é‡å¤§å»ºè­°ç”¨ chunks)
                const batchLimit = 500;
                let batch = writeBatch(db);
                let count = 0;
                let totalImported = 0;

                for (const record of records) {
                    const newRef = doc(collection(db, "users", currentUser.uid, "records"));
                    // ç¢ºä¿åŒ¯å…¥çš„è³‡æ–™åŒ…å«å¿…è¦æ¬„ä½ï¼Œä¸¦é‡æ–°è³¦äºˆ Timestamp
                    // å¦‚æœ JSON è£¡é¢çš„ createdAt æ˜¯å­—ä¸²ï¼Œå»ºè­°åœ¨é€™è£¡è½‰å› Timestampï¼Œæˆ–ç›´æ¥çµ¦æ–°çš„
                    const docData = {
                        ...record,
                        importedAt: Timestamp.now() 
                    };
                    
                    batch.set(newRef, docData);
                    count++;
                    totalImported++;

                    if (count >= batchLimit) {
                        await batch.commit();
                        batch = writeBatch(db); // é‡ç½® batch
                        count = 0;
                    }
                }

                if (count > 0) {
                    await batch.commit(); // æäº¤å‰©ä¸‹çš„
                }

                alert(`æˆåŠŸå¾©åŸ ${totalImported} ç­†è³‡æ–™ï¼`);
                e.target.value = ''; // é‡ç½® input

            } catch (error) {
                console.error("å¾©åŸå¤±æ•—:", error);
                alert("å¾©åŸå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚\n" + error.message);
            }
        };
        reader.readAsText(file);
    });

</script>
</body>
</html>

